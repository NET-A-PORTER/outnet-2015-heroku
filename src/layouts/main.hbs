<!DOCTYPE html>
<html ng-app="app">
<head ng-controller="HeadCtrl">
	<title>Preston</title>
	<link rel="stylesheet" href="/css/style.css">
	<link rel="stylesheet" ng-repeat="content in style.contents" ng-href="/css/:: style.name ::/:: content ::/style.css">
</head>
<body>
	<div class="preston-heading" ng-controller="NavCtrl">
		<div class="preston-container">
			<div class="preston-nav">
				<div class="preston-nav-item"
					ng-repeat="style in nav"
					ui-sref="guide({ name: style.name })"
					ui-sref-active="active">:: style.title ::</div>
			</div>
			<div class="preston-title preston-nav-item" ui-sref="home">Preston</div>
		</div>
	</div>
	<div class="preston-container" ui-view>
		{{{@body}}}
	</div>
	<script src="/js/angular.js"></script>
	<script src="/js/angular-router.js"></script>
	<script>
	angular
		.module('app', ['ui.router'])
		.config(function($interpolateProvider, $stateProvider, $urlRouterProvider) {
			// stop conflicting with handlebars
			$interpolateProvider.startSymbol('::');
			$interpolateProvider.endSymbol('::');

			// routing
			$urlRouterProvider.otherwise('/');
			$stateProvider
				.state('home', {
					url: '/',
					templateUrl: 'templates/home.html'
				})
				.state('guide', {
					url: '/style/:name',
					templateUrl: 'templates/guide.html'
				});
		})
		.service('MessageService', function() {
			function display(type, message) {
				alert(message);
			}
			return {
				error: function(message) {
					display('error', message);
				}
			};
		})
		.service('ApiService', function($http, MessageService) {
			return function(version, controller) {
				var versionParsed = parseFloat(version).toFixed(1);
				var baseUrl = '/api/' + versionParsed + '/' + controller;

				return {
					get: function(path) {
						return $http
							.get(baseUrl + (path || ''))
							.error(function(data) {
								MessageService.error(data.message || 'An error occured');
							});
					}
				}
			}
		})
		.service('StylesService', function(ApiService) {
			var api = new ApiService(1.0, 'styles');

			// TODO: cache responses as some are
			// used in multiple controller instances
			return {
				get: function(name) {
					return api.get('/' + name).then(function(result) {
						return result.data;
					});
				},
				getAll: function() {
					return api.get().then(function(result) {
						return result.data;
					});
				}
			};
		})
		.controller('HeadCtrl', function($scope, StylesService) {
			StylesService
				.get('outnet-2015')
				.then(function(result) {
					$scope.style = result;
				});
		})
		.controller('NavCtrl', function($scope, StylesService) {
			StylesService
				.getAll()
				.then(function(result) {
					$scope.nav = result;
				});
		})
		.controller('StyleCtrl', function($scope, StylesService) {

		});
	</script>
</body>
</html>